<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProcessadorLDs - Processamento de Listas de Documentos</title>
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- xlsx-js-style para processamento de Excel com suporte a formata√ß√£o de c√©lulas -->
  <!-- Compat√≠vel com SheetJS, mas adiciona suporte a estilos (cores, fontes, etc.) -->
  <!-- Tentar UNPKG primeiro, fallback para jsDelivr -->
  <script>
    (function() {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.min.js';
      script.onerror = function() {
        console.warn('UNPKG falhou, tentando jsDelivr...');
        const script2 = document.createElement('script');
        script2.src = 'https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js';
        script2.onerror = function() {
          console.error('‚ùå Erro ao carregar xlsx-js-style de ambos os CDNs');
          alert('Erro: N√£o foi poss√≠vel carregar a biblioteca XLSX. Verifique sua conex√£o com a internet.');
        };
        document.head.appendChild(script2);
      };
      document.head.appendChild(script);
    })();
  </script>
  
  <!-- PapaParse para processamento de CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Chart.js para gr√°ficos 2D interativos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Plotly.js para gr√°ficos 3D e mapas de calor -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  
  <!-- Chart.js Datalabels Plugin para exibir valores nos gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        if (typeof XLSX === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
          script.onerror = function() {
            alert('Erro: N√£o foi poss√≠vel carregar a biblioteca XLSX. Verifique sua conex√£o com a internet e recarregue a p√°gina.');
          };
          document.head.appendChild(script);
        }
      }, 500);
      
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('teste') === 'true') {
        const chk = document.getElementById('chkModoTeste');
        if (chk) chk.checked = true;
      }
    });
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìÑ ProcessadorLDs</h1>
      <p>Processamento e Valida√ß√£o de Listas de Documentos</p>
    </header>
    
    <main>
      <!-- Se√ß√£o de Upload -->
      <section class="section">
        <h2>Selecionar Arquivos</h2>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">Arraste arquivos aqui ou clique para selecionar</div>
          <div class="upload-hint">Formatos suportados: CSV, XLSX</div>
          <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls">
        </div>
        <div class="buttons-group">
          <button class="btn btn-primary" id="btnProcessar" disabled>Processar</button>
          <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
        </div>
      </section>
      
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
      </div>
      
      <!-- Estat√≠sticas -->
      <section class="section hidden" id="sectionEstatisticas">
        <h2>Estat√≠sticas</h2>
        <div class="stats-grid" id="statsGrid"></div>
      </section>
      
      <!-- Status por Arquivo -->
      <section class="section hidden" id="sectionStatus">
        <h2>Status por Arquivo</h2>
        <div class="table-container">
          <table id="tableStatus">
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      
      <!-- Modal de Detalhes -->
      <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal-container">
          <div class="modal-header">
            <h2 class="modal-title">Detalhes do Processamento</h2>
            <button class="modal-close" id="modalClose">&times;</button>
          </div>
          <div class="modal-content" id="modalContent">
            <!-- Conte√∫do ser√° inserido aqui via JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Problemas -->
      <section class="section hidden" id="sectionProblemas">
        <h2>Problemas Identificados</h2>
        <ul class="problems-list" id="problemsList"></ul>
      </section>
      
      <!-- Dados Processados -->
      <section class="section hidden" id="sectionDados">
        <h2>Dados Processados</h2>
        <div class="table-container">
          <table id="tableDados">
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>LD</th>
                <th>Revis√£o</th>
                <th>NO VALE</th>
                <th>PREVISTO</th>
                <th>PREVISTO 1</th>
                <th>PREVISTO 2</th>
                <th>REPROGRAMADO</th>
                <th>FORMATO</th>
                <th>PAGS/ FOLHAS</th>
                <th>Disciplina</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      
      <!-- Exporta√ß√£o -->
      <section class="section hidden" id="sectionExportacao">
        <h2>Exportar Resultados</h2>
        <div class="export-options">
          <select id="exportFormat">
            <option value="json">JSON (Recomendado)</option>
            <option value="xlsx">Excel (XLSX)</option>
            <option value="csv">CSV</option>
          </select>
          <button class="btn btn-success" id="btnExportar">Exportar</button>
        </div>
      </section>
      
      <!-- P√≥s-Processamento -->
      <section class="section hidden" id="sectionPosProcessamento">
        <h2>P√≥s-Processamento com CSV Gerencial</h2>
        
        <!-- Status de Carregamento do CSV -->
        <div class="csv-loading-status hidden" id="csvLoadingStatus" style="margin-bottom: 20px; padding: 15px; background: var(--color-primary-lightest); border-radius: 8px; border-left: 4px solid var(--color-primary);">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="loading-spinner" style="width: 20px; height: 20px; border: 3px solid rgba(0, 126, 122, 0.3); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div>
              <strong style="color: var(--color-primary);">Carregando CSV...</strong>
              <div id="csvLoadingDetails" style="font-size: 0.9em; color: var(--color-text-light); margin-top: 4px;"></div>
            </div>
          </div>
        </div>
        
        <div class="pos-processamento-container">
          <div class="upload-csv-area" id="uploadCSVArea">
            <div class="upload-icon">üìä</div>
            <div class="upload-text" id="csvUploadText">Selecione o CSV Gerencial Consolidado (GA)</div>
            <div class="upload-hint">Arquivo: RELATORIO_GERENCIAL_CONSOLIDADO_*.csv</div>
            <input type="file" id="csvInput" accept=".csv">
          </div>
          <div class="buttons-group" style="margin-top: 20px;">
            <button class="btn btn-primary" id="btnPosProcessar" disabled>Processar Valida√ß√£o</button>
          </div>
          
          <!-- Dados Salvos -->
          <div class="dados-salvos-container" id="dadosSalvosContainer" style="margin-top: 20px; display: none;">
            <div class="card" style="padding: 15px; background: var(--color-primary-lightest); border-left: 4px solid var(--color-primary); border-radius: 8px;">
              <h4 style="margin-bottom: 10px; color: var(--color-primary);">üíæ Dados Salvos</h4>
              <div id="dadosSalvosInfo" style="margin-bottom: 10px; font-size: 0.9em; color: var(--color-text-light);"></div>
              <div class="buttons-group" style="margin-top: 10px;">
                <button class="btn btn-secondary" id="btnCarregarDadosSalvos">Carregar Dados Salvos</button>
                <button class="btn btn-primary" id="btnSalvarDadosAtuais">Salvar Dados Atuais</button>
                <button class="btn btn-danger" id="btnLimparDadosSalvos">Limpar Dados Salvos</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resultados do P√≥s-Processamento -->
        <div class="pos-processamento-resultados hidden" id="posProcessamentoResultados">
          <!-- Estat√≠sticas -->
          <div class="stats-grid" id="posStatsGrid"></div>
          
          <!-- Exporta√ß√£o de Resultados -->
          <div class="export-section" style="margin-top: 20px;">
            <h3>Exportar Resultados do P√≥s-Processamento</h3>
            <div class="export-options">
              <select id="exportPosProcessamentoFormat">
                <option value="json">JSON (Recomendado)</option>
                <option value="xlsx">Excel (XLSX)</option>
                <option value="csv">CSV</option>
              </select>
              <button class="btn btn-success" id="btnExportarPosProcessamento">Exportar</button>
            </div>
          </div>
          
          <!-- Discrep√¢ncias de Data -->
          <div class="discrepancias-container hidden" id="discrepanciasContainer" style="margin-top: 30px;">
            <h3 style="color: var(--color-error); margin-bottom: 15px;">‚ö†Ô∏è Discrep√¢ncias de Data</h3>
            <div class="table-container">
              <table id="tableDiscrepancias">
                <thead>
                  <tr>
                    <th>NO VALE</th>
                    <th>Arquivo</th>
                    <th>Data GR Rec (CSV)</th>
                    <th>REALIZADO 2 (LD)</th>
                    <th>Diferen√ßa (dias)</th>
                    <th>A√ß√£o Sugerida</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Dashboard -->
      <section class="section hidden" id="sectionDashboard">
        <div class="dashboard-header">
          <h2>Dashboard de An√°lise</h2>
          <div class="dashboard-tabs">
            <button class="tab-button active" data-tab="resultados">Resultados</button>
            <button class="tab-button" data-tab="dashboard">Dashboard</button>
          </div>
        </div>
        
        <!-- Conte√∫do da aba Resultados -->
        <div class="tab-content active" id="tabResultados">
          <div class="pos-processamento-resultados-tab" id="posProcessamentoResultadosTab">
            <!-- Conte√∫do ser√° movido aqui dinamicamente -->
          </div>
        </div>
        
        <!-- Conte√∫do da aba Dashboard -->
        <div class="tab-content hidden" id="tabDashboard">
          <!-- Painel de Filtros -->
          <div class="dashboard-filters">
            <h3>Filtros</h3>
            <div class="filters-grid">
              <div class="filter-group">
                <label>Projeto/SE</label>
                <select id="filterProjeto" multiple>
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Empresa</label>
                <select id="filterEmpresa" multiple>
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="filter-group">
                <label>LD</label>
                <select id="filterLD" multiple>
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Disciplina</label>
                <select id="filterDisciplina" multiple>
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Formato</label>
                <select id="filterFormato" multiple>
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Per√≠odo (Data Previsto)</label>
                <div style="display: flex; gap: 10px;">
                  <input type="date" id="filterDataInicio" style="flex: 1;">
                  <input type="date" id="filterDataFim" style="flex: 1;">
                </div>
              </div>
            </div>
            <div class="filters-actions">
              <button class="btn btn-primary" id="btnAplicarFiltros">Aplicar Filtros</button>
              <button class="btn btn-secondary" id="btnLimparFiltros">Limpar Filtros</button>
            </div>
          </div>
          
          <!-- Grid de Visualiza√ß√µes -->
          <div class="dashboard-visualizations">
            <!-- Estat√≠sticas Resumidas -->
            <div class="dashboard-stats" id="dashboardStats"></div>
            
            <!-- Gr√°fico 1: Temporal Previsto vs Realizado -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Previsto vs Realizado (Temporal)</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container" style="display: flex; gap: 20px; align-items: flex-start;">
                <div style="flex: 2;">
                  <canvas id="chartTemporal"></canvas>
                </div>
                <div style="flex: 1; min-width: 250px;">
                  <!-- Tabela de resumo ser√° inserida aqui via JavaScript -->
                </div>
              </div>
            </div>
            
            <!-- Gr√°fico 2: Mapa de Calor Temporal -->
            <div class="chart-card two-thirds">
              <div class="chart-header">
                <h3>Mapa de Calor Temporal por Disciplina</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container">
                <div id="chartMapaCalorTemporal"></div>
              </div>
            </div>
            
            <!-- Gr√°fico 3: Distribui√ß√£o por Disciplina -->
            <div class="chart-card one-third">
              <div class="chart-header">
                <h3>Distribui√ß√£o por Disciplina</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container">
                <canvas id="chartDistribuicao"></canvas>
                <!-- Tabela de resumo ser√° inserida aqui via JavaScript -->
              </div>
            </div>
            
            <!-- Gr√°fico 4: 3D Disciplina √ó Status √ó Quantidade -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Visualiza√ß√£o 3D: Documentos por Disciplina e Status</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container" style="height: 500px;">
                <div id="chart3D" style="width: 100%; height: 100%;"></div>
              </div>
            </div>
            
            <!-- Gr√°fico 5: Mapa de Calor Taxa de Emiss√£o -->
            <div class="chart-card half-width">
              <div class="chart-header">
                <h3>Mapa de Calor: Taxa de Emiss√£o</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container">
                <div id="chartMapaCalorEmissao"></div>
              </div>
            </div>
            
            <!-- Gr√°fico 6: Mapa de Calor Taxa de Certifica√ß√£o -->
            <div class="chart-card half-width">
              <div class="chart-header">
                <h3>Mapa de Calor: Taxa de Certifica√ß√£o</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container">
                <div id="chartMapaCalorCertificacao"></div>
              </div>
            </div>
            
            <!-- Gr√°fico 7: Barras Empilhadas Status por Projeto -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Status por Projeto</h3>
                <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
              </div>
              <div class="chart-container" style="display: flex; gap: 20px; align-items: flex-start;">
                <div style="flex: 2;">
                  <canvas id="chartBarrasEmpilhadas"></canvas>
                </div>
                <div id="statusProjetoResumo" style="flex: 1; min-width: 280px;">
                  <!-- Tabela de resumo ser√° inserida aqui via JavaScript -->
                </div>
              </div>
            </div>
            
            <!-- Gr√°fico 8: Gantt Timeline -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Evolu√ß√£o de Documentos por Per√≠odo</h3>
                <div class="chart-header-controls" style="display: flex; gap: 10px; align-items: center;">
                  <div class="btn-group-toggle" style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--color-primary);">
                    <button class="btn-toggle active" id="btnGanttMensal" data-periodo="mensal" style="padding: 6px 12px; border: none; background: var(--color-primary); color: white; cursor: pointer; font-size: 0.85em;">Mensal</button>
                    <button class="btn-toggle" id="btnGanttSemanal" data-periodo="semanal" style="padding: 6px 12px; border: none; background: white; color: var(--color-primary); cursor: pointer; font-size: 0.85em;">Semanal</button>
                  </div>
                  <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
                </div>
              </div>
              <div class="chart-container" style="height: 400px;">
                <canvas id="chartGantt"></canvas>
              </div>
            </div>
            
            <!-- Gr√°fico 9: √Årea Ac√∫mulo Temporal -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Ac√∫mulo de Documentos (Temporal)</h3>
                <div class="chart-header-controls" style="display: flex; gap: 10px; align-items: center;">
                  <div class="btn-group-toggle" style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--color-primary);">
                    <button class="btn-toggle active" id="btnAcumuloMensal" data-periodo="mensal" style="padding: 6px 12px; border: none; background: var(--color-primary); color: white; cursor: pointer; font-size: 0.85em;">Mensal</button>
                    <button class="btn-toggle" id="btnAcumuloSemanal" data-periodo="semanal" style="padding: 6px 12px; border: none; background: white; color: var(--color-primary); cursor: pointer; font-size: 0.85em;">Semanal</button>
                  </div>
                  <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartAreaAcumulo"></canvas>
              </div>
            </div>
            
            <!-- Gr√°fico 10: √Årea Ac√∫mulo Certifica√ß√£o -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h3>Ac√∫mulo de Certifica√ß√£o (Temporal)</h3>
                <div class="chart-header-controls" style="display: flex; gap: 10px; align-items: center;">
                  <div class="btn-group-toggle" style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--color-primary);">
                    <button class="btn-toggle active" id="btnAcumuloCertMensal" data-periodo="mensal" style="padding: 6px 12px; border: none; background: var(--color-primary); color: white; cursor: pointer; font-size: 0.85em;">Mensal</button>
                    <button class="btn-toggle" id="btnAcumuloCertSemanal" data-periodo="semanal" style="padding: 6px 12px; border: none; background: white; color: var(--color-primary); cursor: pointer; font-size: 0.85em;">Semanal</button>
                  </div>
                  <button class="btn-icon" title="Exportar gr√°fico">üì•</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartAreaAcumuloCertificacao"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- Scripts -->
  <script src="js/processor.js"></script>
  <script src="js/validator.js"></script>
  <script src="js/exporter.js"></script>
  <script src="js/postprocessor.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
